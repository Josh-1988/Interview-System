<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Interview Panel System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#6366f1;--primary-dark:#4f46e5;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--ai:#ec4899;--bg:#0f172a;--card:#1e293b;--border:rgba(99,102,241,0.2);--text:#f8fafc;--muted:#94a3b8}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.bg-grid{position:fixed;inset:0;background-image:linear-gradient(rgba(99,102,241,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(99,102,241,.04) 1px,transparent 1px);background-size:50px 50px;pointer-events:none}

/* SCREENS */
.screen{display:none;position:relative;z-index:1}
.screen.active{display:flex}
#loginScreen,#signupScreen{min-height:100vh;align-items:center;justify-content:center;padding:1rem}
#appScreen{flex-direction:column}

/* LOGIN */
.auth-box{background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:24px;padding:2.5rem;width:100%;max-width:460px;box-shadow:0 30px 60px rgba(0,0,0,.5)}
.auth-logo{width:72px;height:72px;background:linear-gradient(135deg,var(--primary),var(--ai));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 1.5rem}
.auth-title{font-size:1.9rem;font-weight:800;text-align:center;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}
.auth-sub{text-align:center;color:var(--muted);margin-bottom:2rem}
.form-group{margin-bottom:1.25rem}
.form-label{display:block;margin-bottom:.5rem;font-weight:600;color:#e2e8f0;font-size:.95rem}
.req{color:var(--danger);margin-left:2px}
.form-input,.form-select,.form-textarea{width:100%;padding:.9rem 1.1rem;background:rgba(30,41,59,.7);border:1.5px solid rgba(99,102,241,.25);border-radius:10px;color:#fff;font-size:.95rem;font-family:inherit;transition:all .25s}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
.form-input.valid{border-color:var(--success)}
.form-input.invalid{border-color:var(--danger)}
.form-hint{font-size:.8rem;color:var(--muted);margin-top:.35rem}
.form-err{font-size:.8rem;color:var(--danger);margin-top:.35rem;display:none}
.form-err.show{display:block}
.form-textarea{resize:vertical;min-height:90px}
.form-select option{background:#1e293b}
.btn{display:block;width:100%;padding:.9rem 1.25rem;border:none;border-radius:10px;font-weight:700;font-family:inherit;font-size:.95rem;cursor:pointer;transition:all .25s;text-align:center}
.btn:hover{transform:translateY(-1px)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 15px rgba(99,102,241,.35)}
.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff}
.btn-danger{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.3)}
.btn-ai{background:linear-gradient(135deg,var(--ai),#f43f5e);color:#fff;box-shadow:0 4px 15px rgba(236,72,153,.35)}
.btn-sm{width:auto;padding:.55rem 1.1rem;font-size:.85rem;display:inline-block}
.btn-row{display:flex;gap:.75rem;margin-top:1.25rem}
.btn-row .btn{flex:1}
.quick-btns{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border)}
.quick-btn{padding:.7rem;background:rgba(99,102,241,.08);border:1px solid var(--border);border-radius:8px;color:#818cf8;font-weight:600;cursor:pointer;font-family:inherit;font-size:.85rem;transition:all .25s}
.quick-btn:hover{background:rgba(99,102,241,.18)}
.auth-link{text-align:center;margin-top:1.25rem;color:var(--muted);font-size:.9rem}
.auth-link a{color:var(--primary);text-decoration:none;font-weight:600}

/* APP LAYOUT */
.app-wrap{max-width:1600px;margin:0 auto;padding:1.5rem;width:100%}
.header{background:rgba(15,23,42,.7);border:1px solid var(--border);border-radius:20px;padding:1.5rem 2rem;margin-bottom:1.5rem}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;gap:1rem;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:.9rem}
.logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--primary),var(--ai));border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:22px}
.logo-text h1{font-size:1.35rem;font-weight:800;background:linear-gradient(135deg,#fff,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-text p{font-size:.8rem;color:var(--muted)}
.user-bar{display:flex;align-items:center;gap:.9rem}
.user-avatar{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),var(--ai));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;flex-shrink:0}
.user-name{font-weight:600;font-size:.95rem}
.user-role{font-size:.8rem;color:var(--muted)}
.tabs{display:flex;gap:.4rem;background:rgba(30,41,59,.5);padding:.4rem;border-radius:14px;flex-wrap:wrap}
.tab{padding:.65rem 1.25rem;border-radius:10px;background:transparent;border:none;color:var(--muted);font-weight:600;cursor:pointer;font-family:inherit;font-size:.9rem;transition:all .25s;white-space:nowrap}
.tab.active{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}

/* CARDS & LAYOUT */
.card{background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:20px;padding:1.75rem;margin-bottom:1.5rem}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:.75rem}
.card-title{font-size:1.35rem;font-weight:700}
.btn-group{display:flex;gap:.5rem;flex-wrap:wrap}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;margin-bottom:1.5rem}
.stat-card{background:rgba(15,23,42,.6);border:1px solid var(--border);border-radius:18px;padding:1.5rem;transition:all .3s}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 15px 35px rgba(99,102,241,.25)}
.stat-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:.9rem}
.stat-label{color:var(--muted);font-size:.85rem;margin-bottom:.35rem}
.stat-value{font-size:2.2rem;font-weight:800}

/* TABLES */
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:.9rem 1rem;font-size:.8rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:2px solid var(--border)}
td{padding:1.1rem 1rem;border-bottom:1px solid rgba(99,102,241,.08)}
tr:hover td{background:rgba(99,102,241,.04)}

/* BADGES */
.badge{display:inline-block;padding:.4rem .85rem;border-radius:8px;font-size:.78rem;font-weight:700}
.badge-success{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}
.badge-info{background:rgba(99,102,241,.15);color:#818cf8;border:1px solid rgba(99,102,241,.3)}
.badge-warning{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
.badge-danger{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.badge-ai{background:linear-gradient(135deg,var(--ai),#f43f5e);color:#fff;font-size:.7rem;padding:.25rem .65rem;border-radius:20px}

/* ACTION BUTTONS */
.act-btn{padding:.45rem .9rem;border-radius:7px;border:1px solid var(--border);background:rgba(99,102,241,.08);color:#818cf8;font-size:.82rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .25s;margin-right:.4rem}
.act-btn:hover{background:rgba(99,102,241,.18)}
.act-btn.red{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25);color:#ef4444}
.act-btn.red:hover{background:rgba(239,68,68,.18)}
.act-btn.green{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.25);color:#10b981}

/* MODAL */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center;padding:1rem}
.modal.open{display:flex}
.modal-box{background:#0f172a;border:1px solid rgba(99,102,241,.35);border-radius:22px;padding:2rem;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.modal-title{font-size:1.3rem;font-weight:700}
.close-btn{width:36px;height:36px;border-radius:8px;background:rgba(239,68,68,.1);border:none;color:#ef4444;font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1}

/* PROGRESS */
.progress-bar{height:8px;background:rgba(99,102,241,.15);border-radius:8px;overflow:hidden;margin-top:.5rem}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--ai));border-radius:8px;transition:width .4s ease}

/* SCORE BUTTONS */
.score-row{display:flex;gap:.6rem;margin:.75rem 0;flex-wrap:wrap}
.score-btn{width:44px;height:44px;border-radius:9px;border:2px solid var(--border);background:rgba(30,41,59,.6);color:var(--muted);font-weight:700;cursor:pointer;font-family:inherit;font-size:.95rem;transition:all .25s}
.score-btn.sel{background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-color:var(--primary);color:#fff}

/* QUESTION ITEMS */
.q-item{background:rgba(30,41,59,.4);border-radius:12px;padding:1.1rem 1.25rem;margin-bottom:.85rem;border:1px solid var(--border)}

/* UPLOAD */
.upload-zone{border:2px dashed rgba(99,102,241,.4);border-radius:14px;padding:2.5rem 2rem;text-align:center;cursor:pointer;transition:all .3s;margin:1.25rem 0}
.upload-zone:hover,.upload-zone.over{border-color:var(--primary);background:rgba(99,102,241,.07)}
.upload-zone .icon{font-size:2.5rem;margin-bottom:.75rem}
.preview-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.75rem;margin-top:1rem}
.prev-stat{background:rgba(99,102,241,.08);border-radius:10px;padding:.85rem;text-align:center}
.prev-stat-val{font-size:1.4rem;font-weight:700}
.prev-stat-lbl{font-size:.78rem;color:var(--muted);margin-top:.25rem}
.template-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin:.75rem 0}
.tmpl-btn{padding:.7rem;background:rgba(99,102,241,.1);border:1px solid var(--border);border-radius:8px;color:#818cf8;font-weight:600;cursor:pointer;font-family:inherit;font-size:.85rem;text-align:center;transition:all .25s}
.tmpl-btn:hover{background:rgba(99,102,241,.2)}

/* AI SECTIONS */
.ai-box{background:rgba(236,72,153,.06);border:2px solid rgba(236,72,153,.25);border-radius:14px;padding:1.5rem;margin:1.25rem 0}
.ai-box-title{font-weight:700;color:var(--ai);margin-bottom:.75rem;display:flex;align-items:center;gap:.5rem;font-size:1.05rem}
.skill-bar{margin-bottom:.85rem}
.skill-hdr{display:flex;justify-content:space-between;margin-bottom:.4rem;font-size:.9rem}
.info-box{background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.2);border-radius:10px;padding:1rem;margin:.75rem 0}

/* CANDIDATE CARD (panelist view) */
.cand-card{background:rgba(30,41,59,.4);border:1px solid var(--border);border-radius:14px;padding:1.25rem 1.5rem;margin-bottom:.85rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .3s;flex-wrap:wrap;gap:.75rem}
.cand-card:hover{background:rgba(99,102,241,.1);border-color:rgba(99,102,241,.4);transform:translateX(4px)}

/* EMPTY STATE */
.empty{text-align:center;color:var(--muted);padding:3rem;line-height:1.8}

@media(max-width:768px){
  .stats-grid{grid-template-columns:1fr 1fr}
  .tabs{overflow-x:auto}
  .card-header{flex-direction:column;align-items:flex-start}
  .btn-group{width:100%}
}
</style>
</head>
<body>
<div class="bg-grid"></div>

<!-- LOGIN -->
<div id="loginScreen" class="screen active">
  <div class="auth-box">
    <div class="auth-logo">üéØ</div>
    <h1 class="auth-title">AI Interview System</h1>
    <p class="auth-sub">Intelligent Candidate Evaluation Platform</p>
    <form onsubmit="handleLogin(event)">
      <div class="form-group">
        <label class="form-label">Email Address</label>
        <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <button type="submit" class="btn btn-primary">üîê Sign In</button>
    </form>
    <p class="auth-link">No account? <a href="#" onclick="showScreen('signupScreen'); return false;">Sign Up as Panelist</a></p>
    <div class="quick-btns">
      <button class="quick-btn" onclick="doQuickLogin('admin')">üë®‚Äçüíº Admin Demo</button>
      <button class="quick-btn" onclick="doQuickLogin('panelist')">üë§ Panelist Demo</button>
    </div>
  </div>
</div>

<!-- SIGNUP -->
<div id="signupScreen" class="screen">
  <div class="auth-box">
    <div class="auth-logo">üìù</div>
    <h1 class="auth-title">Create Account</h1>
    <p class="auth-sub">Join as a panelist to start evaluating</p>
    <form onsubmit="handleSignup(event)">
      <div class="form-group">
        <label class="form-label">Full Name <span class="req">*</span></label>
        <input type="text" id="suName" class="form-input" placeholder="Jane Smith" required minlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Email Address <span class="req">*</span></label>
        <input type="email" id="suEmail" class="form-input" placeholder="jane@company.com" required>
      </div>
      <div class="form-group">
        <label class="form-label">Position / Title <span class="req">*</span></label>
        <input type="text" id="suPosition" class="form-input" placeholder="Senior Engineer" required>
      </div>
      <div class="form-group">
        <label class="form-label">Password <span class="req">*</span></label>
        <input type="password" id="suPassword" class="form-input" placeholder="Min 6 characters" required minlength="6">
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password <span class="req">*</span></label>
        <input type="password" id="suConfirm" class="form-input" placeholder="Repeat password" required minlength="6">
      </div>
      <button type="submit" class="btn btn-success">‚úÖ Create Account</button>
    </form>
    <p class="auth-link">Already have an account? <a href="#" onclick="showScreen('loginScreen'); return false;">Sign In</a></p>
  </div>
</div>

<!-- MAIN APP -->
<div id="appScreen" class="screen">
  <div class="app-wrap">
    <div class="header">
      <div class="header-top">
        <div class="logo">
          <div class="logo-icon">üéØ</div>
          <div class="logo-text">
            <h1>AI Interview System</h1>
            <p id="roleLabel">Dashboard</p>
          </div>
        </div>
        <div class="user-bar">
          <div>
            <div class="user-name" id="uName">User</div>
            <div class="user-role" id="uEmail">email</div>
          </div>
          <div class="user-avatar" id="uAvatar">U</div>
          <button class="btn btn-danger btn-sm" onclick="handleLogout()">üö™ Logout</button>
        </div>
      </div>
      <div class="tabs" id="navTabs"></div>
    </div>
    <div id="pageContent"></div>
  </div>
</div>

<!-- MODAL -->
<div id="globalModal" class="modal" onclick="if(event.target===this) closeModal()">
  <div class="modal-box" id="modalBody"></div>
</div>

<script>
/* ========================================================
   DATA LAYER
======================================================== */
function initData() {
  if (!localStorage.getItem('aisys')) {
    const d = {
      users: {
        'admin@system.com': { email:'admin@system.com', password:'admin123', name:'Admin User', role:'admin' }
      },
      candidates: [],
      panelists: [],
      sections: [
        { id:1, name:'Technical Skills', questions:[
          {id:1, text:'Demonstrates strong understanding of core technical concepts'},
          {id:2, text:'Shows practical experience with relevant technologies'}
        ]},
        { id:2, name:'Communication', questions:[
          {id:3, text:'Clarity and coherence in verbal communication'},
          {id:4, text:'Active listening and responsiveness'}
        ]},
        { id:3, name:'Problem Solving', questions:[
          {id:5, text:'Analytical thinking and logical reasoning'},
          {id:6, text:'Creative approaches to challenges'}
        ]},
        { id:4, name:'Cultural Fit', questions:[
          {id:7, text:'Alignment with company values and culture'},
          {id:8, text:'Team collaboration mindset'}
        ]}
      ],
      evaluations: [],
      nCand:1, nPanel:1, nSec:5, nQ:9, nEval:1
    };
    localStorage.setItem('aisys', JSON.stringify(d));
  }
}

function db() { return JSON.parse(localStorage.getItem('aisys')); }
function save(d) { localStorage.setItem('aisys', JSON.stringify(d)); }

initData();

/* ========================================================
   AUTH
======================================================== */
let CU = null; // current user

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass = document.getElementById('loginPassword').value;
  const d = db();
  const u = d.users[email];
  if (u && u.password === pass) {
    CU = u;
    launchApp();
  } else {
    alert('‚ùå Invalid email or password. Please try again.');
  }
}

function doQuickLogin(role) {
  const d = db();
  if (role === 'admin') {
    CU = d.users['admin@system.com'];
    launchApp();
  } else {
    const p = d.panelists[0];
    if (p && d.users[p.email]) {
      CU = d.users[p.email];
      launchApp();
    } else {
      alert('No panelist accounts yet. Please sign up or ask admin to add a panelist first.');
    }
  }
}

function handleSignup(e) {
  e.preventDefault();
  const name = document.getElementById('suName').value.trim();
  const email = document.getElementById('suEmail').value.trim().toLowerCase();
  const position = document.getElementById('suPosition').value.trim();
  const pass = document.getElementById('suPassword').value;
  const confirm = document.getElementById('suConfirm').value;

  if (pass !== confirm) { alert('‚ùå Passwords do not match!'); return; }

  const d = db();
  if (d.users[email]) { alert('‚ùå Email already registered. Please login.'); return; }

  d.panelists.push({ id: d.nPanel++, name, email, position });
  d.users[email] = { email, password: pass, name, role: 'panelist' };
  save(d);
  alert('‚úÖ Account created! You can now sign in.');
  document.getElementById('loginEmail').value = email;
  showScreen('loginScreen');
}

function handleLogout() {
  CU = null;
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  showScreen('loginScreen');
}

function launchApp() {
  showScreen('appScreen');
  document.getElementById('uName').textContent = CU.name;
  document.getElementById('uEmail').textContent = CU.email;
  document.getElementById('uAvatar').textContent = CU.name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('roleLabel').textContent = CU.role === 'admin' ? 'System Administrator' : 'Panelist Dashboard';
  buildNav();
}

function buildNav() {
  const tabs = document.getElementById('navTabs');
  if (CU.role === 'admin') {
    tabs.innerHTML = `
      <button class="tab active" onclick="nav('dashboard',this)">üìä Dashboard</button>
      <button class="tab" onclick="nav('candidates',this)">üë• Candidates</button>
      <button class="tab" onclick="nav('panelists',this)">üë®‚Äçüíº Panelists</button>
      <button class="tab" onclick="nav('questions',this)">üìù Questions</button>
      <button class="tab" onclick="nav('evaluations',this)">‚≠ê Evaluations</button>
    `;
  } else {
    tabs.innerHTML = `
      <button class="tab active" onclick="nav('myevals',this)">üìù My Evaluations</button>
      <button class="tab" onclick="nav('dashboard',this)">üìä Dashboard</button>
    `;
  }
  nav(CU.role === 'admin' ? 'dashboard' : 'myevals');
}

function nav(page, btn) {
  if (btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
  }
  const el = document.getElementById('pageContent');
  const pages = { dashboard: pgDashboard, candidates: pgCandidates, panelists: pgPanelists, questions: pgQuestions, evaluations: pgEvaluations, myevals: pgMyEvals };
  if (pages[page]) pages[page](el);
}

/* ========================================================
   MODAL HELPERS
======================================================== */
function openModal(html) {
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('globalModal').classList.add('open');
}
function closeModal() {
  document.getElementById('globalModal').classList.remove('open');
}

/* ========================================================
   RANKINGS & AI ANALYSIS
======================================================== */
function calcRankings() {
  const d = db();
  const map = {};
  d.evaluations.forEach(e => {
    if (!map[e.candidateId]) {
      map[e.candidateId] = { scores:[], cand: d.candidates.find(c=>c.id===e.candidateId) };
    }
    map[e.candidateId].scores.push(e.avgScore);
  });
  return Object.entries(map)
    .filter(([,v]) => v.cand)
    .map(([id,v]) => {
      const avg = v.scores.reduce((a,b)=>a+b,0)/v.scores.length;
      const pct = (avg/5)*100;
      let rec = 'Not Recommended', insight = 'Needs improvement';
      if (pct>=80){ rec='Highly Recommended'; insight='Exceptional fit'; }
      else if (pct>=65){ rec='Recommended'; insight='Strong candidate'; }
      else if (pct>=50){ rec='Consider'; insight='Potential match'; }
      return { candId:parseInt(id), name:v.cand.name, position:v.cand.position, avg, pct, count:v.scores.length, rec, insight };
    })
    .sort((a,b)=>b.avg-a.avg);
}

function aiAnalysis(cand, evals) {
  if (!evals || !evals.length) return { avg:0, pct:0, conf:0, cons:0, strengths:[], improvs:[], skills:{}, rec:'No Data', summary:'No evaluations yet.', count:0 };
  const d = db();
  const skills = {};
  d.sections.forEach(sec => {
    const qids = sec.questions.map(q=>q.id);
    let tot=0, cnt=0;
    evals.forEach(ev => { qids.forEach(qi => { if(ev.scores[qi]!==undefined){ tot+=ev.scores[qi]; cnt++; } }); });
    skills[sec.name] = cnt>0 ? tot/cnt : 0;
  });
  const avg = evals.reduce((s,e)=>s+e.avgScore,0)/evals.length;
  const pct = (avg/5)*100;
  const strengths = Object.entries(skills).filter(([,s])=>s>=4.0).map(([n,s])=>({ area:n, desc:'Excellent ‚Äî '+s.toFixed(1)+'/5.0' }));
  const improvs  = Object.entries(skills).filter(([,s])=>s<=2.5).map(([n,s])=>({ area:n, desc:'Needs work ‚Äî '+s.toFixed(1)+'/5.0' }));
  let rec, summary, conf;
  const name = cand ? cand.name : 'Candidate';
  if (pct>=80){ rec='Highly Recommended'; conf=95; summary=name+' demonstrates exceptional capability across all competencies. Consistent performance across '+evals.length+' evaluation(s) ('+pct.toFixed(1)+'%) strongly supports a hiring recommendation.'; }
  else if (pct>=65){ rec='Recommended'; conf=85; summary=name+' shows solid competency with minor areas to grow. '+(strengths.length?'Strengths in '+strengths.map(s=>s.area).join(', ')+'. ':'')+' Overall '+pct.toFixed(1)+'% across '+evals.length+' evaluation(s).'; }
  else if (pct>=50){ rec='Consider with Reservations'; conf=70; summary=name+' shows potential but notable gaps remain. '+(improvs.length?'Development needed in '+improvs.map(i=>i.area).join(', ')+'. ':'')+'Score: '+pct.toFixed(1)+'%.'; }
  else { rec='Not Recommended'; conf=90; summary=name+' falls below expected standards at '+pct.toFixed(1)+'% across '+evals.length+' evaluation(s). Significant gaps in multiple areas.'; }
  const scores = evals.map(e=>e.avgScore);
  const mean = scores.reduce((a,b)=>a+b,0)/scores.length;
  const sd = Math.sqrt(scores.reduce((s,x)=>s+Math.pow(x-mean,2),0)/scores.length);
  const cons = Math.max(0, 100 - sd*40);
  return { avg, pct, conf, cons, strengths, improvs, skills, rec, summary, count:evals.length };
}

/* ========================================================
   DASHBOARD
======================================================== */
/* active dashboard view: 'rankings' | 'report' */
let dashView = 'rankings';
let dashFilter = 'all'; /* all | recommended | pending */

function pgDashboard(el) {
  const d = db();
  const rankings = calcRankings();
  renderDashboard(el, d, rankings);
}

function renderDashboard(el, d, rankings) {
  const recBadge = r => {
    if (r==='Highly Recommended') return 'badge-success';
    if (r==='Recommended') return 'badge-info';
    if (r==='Consider') return 'badge-warning';
    return 'badge-danger';
  };

  /* ---- filter chips ---- */
  const evaluatedIds = new Set(rankings.map(r=>r.candId));
  const pendingCands = d.candidates.filter(c=>!evaluatedIds.has(c.id));

  let filtered = rankings;
  if (dashFilter==='recommended')  filtered = rankings.filter(r=>r.rec==='Highly Recommended'||r.rec==='Recommended');
  if (dashFilter==='consider')     filtered = rankings.filter(r=>r.rec==='Consider');
  if (dashFilter==='not')          filtered = rankings.filter(r=>r.rec==='Not Recommended');
  if (dashFilter==='pending')      filtered = [];   /* handled separately */

  const chips = [
    {key:'all',     label:'All Evaluated ('+rankings.length+')'},
    {key:'recommended', label:'‚úÖ Recommended ('+rankings.filter(r=>r.rec==='Highly Recommended'||r.rec==='Recommended').length+')'},
    {key:'consider',    label:'ü§î Consider ('+rankings.filter(r=>r.rec==='Consider').length+')'},
    {key:'not',         label:'‚ùå Not Recommended ('+rankings.filter(r=>r.rec==='Not Recommended').length+')'},
    {key:'pending',     label:'‚è≥ Not Evaluated Yet ('+pendingCands.length+')'},
  ].map(c=>`<button onclick="dashFilter='${c.key}';pgDashboard(document.getElementById('pageContent'))"
    style="padding:.5rem 1rem;border-radius:20px;border:2px solid ${dashFilter===c.key?'var(--primary)':'var(--border)'};
    background:${dashFilter===c.key?'rgba(99,102,241,.25)':'rgba(30,41,59,.5)'};
    color:${dashFilter===c.key?'#fff':'var(--muted)'};font-weight:600;cursor:pointer;font-size:.82rem;white-space:nowrap;font-family:inherit">
    ${c.label}</button>`).join('');

  /* ---- rankings table rows ---- */
  const rankRows = filtered.map((r,i)=>`
    <tr>
      <td><strong style="color:${i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#f97316':'#fff'}">#${i+1}</strong></td>
      <td><strong style="color:#fff">${r.name}</strong></td>
      <td style="color:var(--muted)">${r.position}</td>
      <td>
        <strong style="color:#fff">${r.avg.toFixed(1)}/5.0</strong>
        <div class="progress-bar" style="margin-top:.35rem"><div class="progress-fill" style="width:${r.pct}%"></div></div>
      </td>
      <td style="text-align:center;font-weight:700">${r.count}</td>
      <td style="color:var(--ai);font-size:.82rem">${r.insight}</td>
      <td><span class="badge ${recBadge(r.rec)}">${r.rec}</span></td>
      <td>
        <button class="act-btn green" onclick="showAIAnalysis(${r.candId})">ü§ñ AI</button>
        <button class="act-btn" onclick="showInlineReport(${r.candId})">üìÑ Report</button>
      </td>
    </tr>`).join('');

  /* ---- pending rows ---- */
  const pendingRows = pendingCands.map(c=>`
    <tr>
      <td style="color:var(--muted)">‚Äî</td>
      <td><strong style="color:#fff">${c.name}</strong></td>
      <td style="color:var(--muted)">${c.position}</td>
      <td style="color:var(--muted)">Not evaluated</td>
      <td style="text-align:center">0</td>
      <td style="color:var(--warning);font-size:.82rem">Awaiting evaluation</td>
      <td><span class="badge badge-warning">‚è≥ Pending</span></td>
      <td>‚Äî</td>
    </tr>`).join('');

  const tableBody = dashFilter==='pending' ? pendingRows : rankRows;
  const emptyMsg  = dashFilter==='pending'
    ? (pendingCands.length ? '' : '<div class="empty">‚úÖ All candidates have been evaluated!</div>')
    : (filtered.length ? '' : '<div class="empty">No candidates match this filter.</div>');

  const exportBtns = rankings.length ? `
    <div class="btn-group">
      <button class="btn btn-ai btn-sm" onclick="dashView='report';pgDashboard(document.getElementById('pageContent'))">üìë Consolidated Report</button>
      <button class="btn btn-success btn-sm" onclick="exportCSV()">üìä CSV</button>
      <button class="btn btn-primary btn-sm" onclick="exportExcel()">üìà Excel</button>
      <button class="btn btn-sm" style="background:rgba(139,92,246,.2);color:#a78bfa" onclick="viewReport()">üìÑ Export PDF</button>
    </div>` : '';

  /* ---- consolidated in-app report ---- */
  const consolidatedHTML = dashView==='report' ? buildInAppReport(rankings, d) : '';

  el.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">üë•</div><div class="stat-label">Total Candidates</div><div class="stat-value">${d.candidates.length}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#14b8a6)">üë®‚Äçüíº</div><div class="stat-label">Active Panelists</div><div class="stat-value">${d.panelists.length}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#f59e0b,#f97316)">üìù</div><div class="stat-label">Evaluations</div><div class="stat-value">${d.evaluations.length}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#ec4899,#f43f5e)">üèÜ</div><div class="stat-label">Ranked</div><div class="stat-value">${rankings.length}</div></div>
    </div>

    <!-- RANKINGS VIEW -->
    <div class="card" id="rankCard" style="${dashView==='report'?'display:none':''}">
      <div class="card-header">
        <h2 class="card-title">üèÜ Candidate Rankings <span class="badge-ai">ü§ñ AI</span></h2>
        ${exportBtns}
      </div>

      <!-- Filter chips -->
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.25rem;padding:.75rem;background:rgba(30,41,59,.3);border-radius:12px">
        ${chips}
      </div>

      ${tableBody || emptyMsg ? `
        <div class="table-wrap">
          <table>
            <thead><tr><th>Rank</th><th>Candidate</th><th>Position</th><th>Score</th><th>Evals</th><th>AI Insight</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>${tableBody}</tbody>
          </table>
        </div>${emptyMsg}` : '<div class="empty">üì≠ No evaluations yet.<br>Panelists need to assess candidates for rankings to appear.</div>'}
    </div>

    <!-- CONSOLIDATED REPORT VIEW -->
    ${dashView==='report' ? `
    <div class="card" id="reportCard">
      <div class="card-header">
        <h2 class="card-title">üìë Consolidated Report <span class="badge-ai">ü§ñ AI</span></h2>
        <div class="btn-group">
          <button class="btn btn-danger btn-sm" onclick="dashView='rankings';pgDashboard(document.getElementById('pageContent'))">‚úï Close Report</button>
          <button class="btn btn-success btn-sm" onclick="exportCSV()">üìä CSV</button>
          <button class="btn btn-primary btn-sm" onclick="exportExcel()">üìà Excel</button>
          <button class="btn btn-sm" style="background:rgba(139,92,246,.2);color:#a78bfa" onclick="viewReport()">üìÑ Export PDF</button>
        </div>
      </div>
      ${consolidatedHTML}
    </div>` : ''}
  `;
}

function buildInAppReport(rankings, d) {
  if (!rankings.length) return '<div class="empty">No evaluated candidates yet.</div>';

  const avgAll = (rankings.reduce((s,r)=>s+r.avg,0)/rankings.length).toFixed(1);
  const recBg  = rec => rec==='Highly Recommended'?'rgba(16,185,129,.12)':rec==='Recommended'?'rgba(99,102,241,.12)':rec==='Consider'?'rgba(245,158,11,.12)':'rgba(239,68,68,.12)';
  const recCol = rec => rec==='Highly Recommended'?'#10b981':rec==='Recommended'?'#818cf8':rec==='Consider'?'#f59e0b':'#ef4444';

  /* summary strip */
  let html = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem">
      ${[
        {v:rankings.length,          l:'Candidates',    c:'var(--primary)'},
        {v:d.evaluations.length,     l:'Evaluations',   c:'var(--success)'},
        {v:d.panelists.length,       l:'Panelists',     c:'var(--ai)'},
        {v:avgAll+'/5.0',            l:'Average Score', c:'var(--warning)'},
        {v:rankings.filter(r=>r.rec==='Highly Recommended').length, l:'Highly Rec.',c:'var(--success)'},
        {v:rankings[0]?.name.split(' ')[0]||'‚Äî', l:'Top Candidate', c:'#fbbf24'},
      ].map(s=>`<div style="background:rgba(30,41,59,.5);border:1px solid var(--border);border-radius:14px;padding:1.1rem;text-align:center">
        <div style="font-size:1.8rem;font-weight:800;color:${s.c}">${s.v}</div>
        <div style="color:var(--muted);font-size:.78rem;margin-top:.25rem">${s.l}</div>
      </div>`).join('')}
    </div>

    <!-- Comparison table -->
    <h3 style="font-weight:700;margin-bottom:1rem;font-size:1.1rem">üìä Comparison Matrix</h3>
    <div class="table-wrap" style="margin-bottom:2rem">
      <table>
        <thead><tr><th>Rank</th><th>Candidate</th><th>Position</th><th>Score</th><th>%</th><th>Evals</th><th>Recommendation</th></tr></thead>
        <tbody>
          ${rankings.map((r,i)=>`
            <tr>
              <td><strong style="color:${i===0?'#fbbf24':i===1?'#94a3b8':i===2?'#f97316':'#e2e8f0'}">#${i+1}</strong></td>
              <td><strong style="color:#fff">${r.name}</strong></td>
              <td style="color:var(--muted)">${r.position}</td>
              <td>
                <strong style="color:${recCol(r.rec)}">${r.avg.toFixed(1)}/5.0</strong>
                <div class="progress-bar" style="margin-top:.35rem"><div class="progress-fill" style="width:${r.pct}%"></div></div>
              </td>
              <td style="font-weight:700">${r.pct.toFixed(0)}%</td>
              <td style="text-align:center">${r.count}</td>
              <td><span style="background:${recBg(r.rec)};color:${recCol(r.rec)};padding:.35rem .85rem;border-radius:20px;font-weight:700;font-size:.8rem;border:1px solid ${recCol(r.rec)}">${r.rec}</span></td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>

    <h3 style="font-weight:700;margin-bottom:1.25rem;font-size:1.1rem">üîç Detailed Candidate Analysis</h3>
  `;

  /* per-candidate blocks */
  rankings.forEach((r, idx) => {
    const cand  = d.candidates.find(c=>c.id===r.candId);
    if (!cand) return;
    const evals = d.evaluations.filter(e=>e.candidateId===r.candId && e.status==='completed');
    const an    = aiAnalysis(cand, evals);
    const bg    = recBg(r.rec);
    const col   = recCol(r.rec);

    const skillBars = Object.entries(an.skills).map(([sk,sc])=>`
      <div style="margin-bottom:.75rem">
        <div style="display:flex;justify-content:space-between;font-size:.85rem;margin-bottom:.35rem">
          <span style="color:#e2e8f0;font-weight:600">${sk}</span>
          <span style="color:var(--muted)">${sc.toFixed(1)}/5.0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:${(sc/5)*100}%"></div></div>
      </div>`).join('');

    const strengths = an.strengths.map(s=>`<div style="background:rgba(16,185,129,.1);border-left:3px solid var(--success);padding:.65rem .85rem;border-radius:6px;margin-bottom:.4rem;font-size:.88rem"><strong style="color:#10b981">${s.area}:</strong> <span style="color:#e2e8f0">${s.desc}</span></div>`).join('');
    const improvs   = an.improvs.map(i=>`<div style="background:rgba(245,158,11,.1);border-left:3px solid var(--warning);padding:.65rem .85rem;border-radius:6px;margin-bottom:.4rem;font-size:.88rem"><strong style="color:#f59e0b">${i.area}:</strong> <span style="color:#e2e8f0">${i.desc}</span></div>`).join('');

    const comments = evals.map(ev=>`
      <div style="background:rgba(30,41,59,.5);border-left:3px solid var(--primary);padding:.85rem 1rem;border-radius:8px;margin-bottom:.6rem">
        <div style="display:flex;justify-content:space-between;margin-bottom:.35rem;flex-wrap:wrap;gap:.35rem">
          <strong style="color:#e2e8f0">${ev.panelistName}</strong>
          <div style="display:flex;gap:.75rem;align-items:center">
            <span style="color:var(--primary);font-weight:700">${ev.avgScore.toFixed(1)}/5.0</span>
            <span style="color:var(--muted);font-size:.78rem">${ev.date}</span>
          </div>
        </div>
        <div style="color:var(--muted);font-size:.88rem">${ev.comment||'No comment provided.'}</div>
      </div>`).join('');

    html += `
      <div style="background:rgba(15,23,42,.7);border:2px solid var(--border);border-radius:18px;padding:1.75rem;margin-bottom:1.5rem">

        <!-- header row -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem;padding-bottom:1.25rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:1rem">
          <div>
            <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
              <span style="background:linear-gradient(135deg,var(--primary),var(--ai));color:#fff;padding:.35rem .9rem;border-radius:20px;font-weight:700;font-size:.88rem">#${idx+1}</span>
              <span style="font-size:1.5rem;font-weight:800;color:#fff">${r.name}</span>
            </div>
            <div style="color:var(--muted);margin-top:.35rem;font-size:.9rem">${cand.position} &bull; ${cand.email} &bull; ${cand.phone}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:2.5rem;font-weight:800;color:${col};line-height:1">${r.avg.toFixed(1)}<span style="font-size:1.1rem;color:var(--muted)">/5.0</span></div>
            <div style="font-size:.88rem;color:var(--muted);margin-bottom:.4rem">${r.pct.toFixed(1)}% performance</div>
            <span style="background:${bg};color:${col};padding:.4rem 1rem;border-radius:20px;font-weight:700;font-size:.82rem;border:1.5px solid ${col}">${r.rec}</span>
          </div>
        </div>

        <!-- metrics strip -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem;margin-bottom:1.25rem">
          <div style="background:rgba(30,41,59,.5);border-radius:10px;padding:.85rem;text-align:center">
            <div style="font-size:1.6rem;font-weight:800;color:var(--primary)">${an.conf}%</div>
            <div style="color:var(--muted);font-size:.75rem;margin-top:.2rem">AI Confidence</div>
          </div>
          <div style="background:rgba(30,41,59,.5);border-radius:10px;padding:.85rem;text-align:center">
            <div style="font-size:1.6rem;font-weight:800;color:var(--success)">${an.cons.toFixed(0)}%</div>
            <div style="color:var(--muted);font-size:.75rem;margin-top:.2rem">Consistency</div>
          </div>
          <div style="background:rgba(30,41,59,.5);border-radius:10px;padding:.85rem;text-align:center">
            <div style="font-size:1.6rem;font-weight:800;color:var(--ai)">${evals.length}</div>
            <div style="color:var(--muted);font-size:.75rem;margin-top:.2rem">Evaluations</div>
          </div>
        </div>

        <!-- AI summary -->
        <div class="ai-box" style="margin-bottom:1.25rem">
          <div class="ai-box-title">ü§ñ AI Analysis</div>
          <p style="color:#e2e8f0;line-height:1.75;font-size:.92rem">${an.summary}</p>
        </div>

        <!-- two-col layout -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;margin-bottom:1.25rem">
          <div>
            <div style="font-weight:700;margin-bottom:.85rem;font-size:.9rem">üìà Competency Breakdown</div>
            ${skillBars}
          </div>
          <div>
            ${strengths ? `<div style="font-weight:700;margin-bottom:.75rem;font-size:.9rem;color:var(--success)">‚úÖ Strengths</div>${strengths}` : ''}
            ${improvs  ? `<div style="font-weight:700;margin:.85rem 0 .75rem;font-size:.9rem;color:var(--warning)">‚ö†Ô∏è Development Areas</div>${improvs}` : ''}
          </div>
        </div>

        <!-- panelist comments -->
        <div style="font-weight:700;margin-bottom:.85rem;font-size:.9rem">üí¨ Panelist Feedback</div>
        ${comments || '<div style="color:var(--muted);font-size:.88rem">No feedback submitted.</div>'}

        <!-- actions -->
        <div style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid var(--border);display:flex;gap:.75rem;flex-wrap:wrap">
          <button class="act-btn green" onclick="showAIAnalysis(${r.candId})">ü§ñ Full AI Analysis</button>
          <button class="act-btn" onclick="startEval(${r.candId});dashView='rankings'">üìù Add Evaluation</button>
        </div>
      </div>`;
  });

  return html;
}

function showInlineReport(candId) {
  /* switch to report view and scroll to that candidate */
  dashView = 'report';
  pgDashboard(document.getElementById('pageContent'));
  setTimeout(()=>{
    const el = document.getElementById('pageContent');
    if (el) el.scrollIntoView({behavior:'smooth'});
  }, 100);
}

/* ========================================================
   CANDIDATES
======================================================== */
let candFilter = 'all'; /* all | evaluated | pending */

function pgCandidates(el) {
  const d = db();
  const evaluatedIds = new Set(d.evaluations.map(e=>e.candidateId));

  let cands = d.candidates;
  if (candFilter==='evaluated') cands = d.candidates.filter(c=>evaluatedIds.has(c.id));
  if (candFilter==='pending')   cands = d.candidates.filter(c=>!evaluatedIds.has(c.id));

  const chips = [
    {k:'all',       l:'All ('+d.candidates.length+')'},
    {k:'evaluated', l:'‚úÖ Evaluated ('+d.candidates.filter(c=>evaluatedIds.has(c.id)).length+')'},
    {k:'pending',   l:'‚è≥ Not Yet Evaluated ('+d.candidates.filter(c=>!evaluatedIds.has(c.id)).length+')'},
  ].map(c=>`<button onclick="candFilter='${c.k}';pgCandidates(document.getElementById('pageContent'))"
    style="padding:.45rem .95rem;border-radius:20px;border:2px solid ${candFilter===c.k?'var(--primary)':'var(--border)'};
    background:${candFilter===c.k?'rgba(99,102,241,.25)':'rgba(30,41,59,.5)'};
    color:${candFilter===c.k?'#fff':'var(--muted)'};font-weight:600;cursor:pointer;font-size:.8rem;font-family:inherit">
    ${c.l}</button>`).join('');

  const rows = cands.map(c => {
    const evalCount = d.evaluations.filter(e=>e.candidateId===c.id).length;
    const evals = d.evaluations.filter(e=>e.candidateId===c.id && e.status==='completed');
    const avg = evals.length ? (evals.reduce((s,e)=>s+e.avgScore,0)/evals.length).toFixed(1) : '‚Äî';
    return `
      <tr>
        <td style="font-family:monospace;color:#818cf8">${c.candidateId}</td>
        <td><strong style="color:#fff">${c.name}</strong></td>
        <td style="color:var(--muted)">${c.position}</td>
        <td style="color:var(--muted)">${c.phone}</td>
        <td style="color:var(--muted)">${c.email}</td>
        <td style="text-align:center"><span class="badge ${evalCount>0?'badge-success':'badge-warning'}">${evalCount>0?evalCount+' eval':'‚è≥ Pending'}</span></td>
        <td style="text-align:center;font-weight:700;color:${evalCount?'#fff':'var(--muted)'}">${avg}${evalCount?'/5.0':''}</td>
        <td>
          <button class="act-btn red" onclick="deleteCandidate(${c.id})">üóëÔ∏è Delete</button>
        </td>
      </tr>`;
  }).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üë• Candidate Management</h2>
        <div class="btn-group">
          <button class="btn btn-primary btn-sm" onclick="modalUploadCandidates()">üì§ Upload CSV/Excel</button>
          <button class="btn btn-success btn-sm" onclick="modalAddCandidate()">‚ûï Add Manually</button>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.25rem">${chips}</div>
      ${cands.length ? `
        <div class="table-wrap">
          <table>
            <thead><tr><th>Candidate ID</th><th>Name</th><th>Position</th><th>Phone</th><th>Email</th><th>Evaluations</th><th>Avg Score</th><th>Action</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : '<div class="empty">üì≠ No candidates match this filter.</div>'}
    </div>`;
}

function modalAddCandidate() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">‚ûï Add New Candidate</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Phone Number <span class="req">*</span></label>
      <input type="tel" id="mPhone" class="form-input" placeholder="0712345678" maxlength="10">
      <div class="form-hint">10 digits starting with 07. Used as unique Candidate ID.</div>
      <div class="form-err" id="mPhoneErr">Phone must be 10 digits starting with 07</div>
    </div>
    <div class="form-group">
      <label class="form-label">Full Name <span class="req">*</span></label>
      <input type="text" id="mName" class="form-input" placeholder="John Doe">
    </div>
    <div class="form-group">
      <label class="form-label">Position Applied <span class="req">*</span></label>
      <input type="text" id="mPos" class="form-input" placeholder="Software Engineer">
    </div>
    <div class="form-group">
      <label class="form-label">Email Address <span class="req">*</span></label>
      <input type="email" id="mEmail" class="form-input" placeholder="john@example.com">
    </div>
    <div class="btn-row">
      <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="submitAddCandidate()">‚úÖ Add Candidate</button>
    </div>
    <script>
      document.getElementById('mPhone').addEventListener('input', function(){
        this.value = this.value.replace(/\\D/g,'').slice(0,10);
        const ok = /^07[0-9]{8}$/.test(this.value);
        this.className = 'form-input ' + (this.value.length===10 ? (ok?'valid':'invalid') : '');
        document.getElementById('mPhoneErr').className = 'form-err' + (!ok && this.value.length>0 ? ' show' : '');
      });
      setTimeout(()=>document.getElementById('mPhone').focus(), 80);
    <\/script>`);
}

function submitAddCandidate() {
  const phone = document.getElementById('mPhone').value.trim();
  const name  = document.getElementById('mName').value.trim();
  const pos   = document.getElementById('mPos').value.trim();
  const email = document.getElementById('mEmail').value.trim();

  if (!/^07[0-9]{8}$/.test(phone)) { alert('‚ùå Invalid phone. Must be 10 digits starting with 07.\nExample: 0712345678'); return; }
  if (name.length < 2) { alert('‚ùå Please enter a valid full name.'); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('‚ùå Please enter a valid email address.'); return; }
  if (!pos) { alert('‚ùå Please enter the position applied for.'); return; }

  const d = db();
  if (d.candidates.some(c => c.candidateId === phone)) { alert('‚ùå A candidate with phone ' + phone + ' already exists.'); return; }
  if (d.candidates.some(c => c.email.toLowerCase() === email.toLowerCase())) { alert('‚ùå A candidate with that email already exists.'); return; }

  d.candidates.push({ id: d.nCand++, candidateId: phone, name, position: pos, email, phone });
  save(d);
  closeModal();
  pgCandidates(document.getElementById('pageContent'));
  alert('‚úÖ Candidate added!\n\nName: ' + name + '\nID: ' + phone + '\nPosition: ' + pos);
}

function deleteCandidate(id) {
  if (!confirm('Delete this candidate? Their evaluations will remain.')) return;
  const d = db();
  d.candidates = d.candidates.filter(c => c.id !== id);
  save(d);
  pgCandidates(document.getElementById('pageContent'));
}

function modalUploadCandidates() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">üì§ Upload Candidates</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="info-box">
      <strong>üìã Template Format:</strong>
      <div class="form-hint" style="margin-top:.5rem">Columns: <code>phone, name, position, email</code></div>
    </div>
    <div class="template-row">
      <button class="tmpl-btn" onclick="dlCandTmpl('csv')">üìÑ Download CSV Template</button>
      <button class="tmpl-btn" onclick="dlCandTmpl('xlsx')">üìä Download Excel Template</button>
    </div>
    <div class="upload-zone" id="czUpload" onclick="document.getElementById('czFile').click()">
      <div class="icon">üìÅ</div>
      <div style="font-weight:600;margin-bottom:.35rem">Click to browse or drag & drop</div>
      <div class="form-hint">Supports .csv, .xlsx, .xls files</div>
    </div>
    <input type="file" id="czFile" style="display:none" accept=".csv,.xlsx,.xls" onchange="parseCandFile(event)">
    <div id="czPreview"></div>
    <script>
      const z = document.getElementById('czUpload');
      z.addEventListener('dragover', e=>{e.preventDefault();z.classList.add('over')});
      z.addEventListener('dragleave', ()=>z.classList.remove('over'));
      z.addEventListener('drop', e=>{e.preventDefault();z.classList.remove('over'); const f=e.dataTransfer.files[0]; if(f) parseCandFile({target:{files:[f]}})});
    <\/script>`);
}

function dlCandTmpl(fmt) {
  const rows = [['phone','name','position','email'],['0712345678','John Doe','Software Engineer','john@example.com'],['0723456789','Jane Smith','Product Manager','jane@example.com']];
  if (fmt==='csv') {
    const blob = new Blob([rows.map(r=>r.join(',')).join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='candidates_template.csv'; a.click();
  } else {
    const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Candidates'); XLSX.writeFile(wb,'candidates_template.xlsx');
  }
}

function parseCandFile(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  if (file.name.endsWith('.csv')) {
    Papa.parse(file, { header:true, complete: r => previewCands(r.data) });
  } else {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      previewCands(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
    };
    reader.readAsArrayBuffer(file);
  }
}

function previewCands(rows) {
  const valid = rows.filter(r => r.phone && r.name && r.position && r.email && /^07[0-9]{8}$/.test(String(r.phone).trim()));
  const invalid = rows.length - valid.length;
  document.getElementById('czPreview').innerHTML = `
    <div class="preview-stats">
      <div class="prev-stat"><div class="prev-stat-val">${rows.length}</div><div class="prev-stat-lbl">Total Rows</div></div>
      <div class="prev-stat"><div class="prev-stat-val" style="color:var(--success)">${valid.length}</div><div class="prev-stat-lbl">Valid</div></div>
      <div class="prev-stat"><div class="prev-stat-val" style="color:var(--danger)">${invalid}</div><div class="prev-stat-lbl">Invalid</div></div>
    </div>
    ${valid.length ? `<button class="btn btn-success" style="margin-top:1rem" onclick='importCands(${JSON.stringify(valid)})'>‚úÖ Import ${valid.length} Candidate(s)</button>` : '<p class="form-hint" style="text-align:center;margin-top:.75rem">No valid rows found.</p>'}`;
}

function importCands(rows) {
  const d = db();
  let added=0, skipped=0;
  rows.forEach(r => {
    const phone = String(r.phone).trim();
    if (d.candidates.some(c=>c.candidateId===phone || c.email.toLowerCase()===r.email.toLowerCase())) { skipped++; return; }
    d.candidates.push({ id:d.nCand++, candidateId:phone, name:r.name, position:r.position, email:r.email, phone });
    added++;
  });
  save(d);
  closeModal();
  pgCandidates(document.getElementById('pageContent'));
  alert('‚úÖ Import Complete!\n\nAdded: ' + added + '\nSkipped (duplicates): ' + skipped);
}

/* ========================================================
   PANELISTS
======================================================== */
function pgPanelists(el) {
  const d = db();
  const rows = d.panelists.map(p => `
    <tr>
      <td><strong style="color:#fff">${p.name}</strong></td>
      <td style="color:var(--muted)">${p.email}</td>
      <td style="color:var(--muted)">${p.position}</td>
      <td><button class="act-btn red" onclick="deletePanelist(${p.id})">üóëÔ∏è Remove</button></td>
    </tr>`).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üë®‚Äçüíº Panelist Management</h2>
        <div class="btn-group">
          <button class="btn btn-primary btn-sm" onclick="modalUploadPanelists()">üì§ Upload CSV/Excel</button>
          <button class="btn btn-success btn-sm" onclick="modalAddPanelist()">‚ûï Add Manually</button>
        </div>
      </div>
      ${d.panelists.length ? `
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Position</th><th>Action</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : '<div class="empty">üì≠ No panelists yet.<br>Add panelists so they can evaluate candidates.</div>'}
    </div>`;
}

function modalAddPanelist() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">‚ûï Add New Panelist</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Full Name <span class="req">*</span></label>
      <input type="text" id="pName" class="form-input" placeholder="Sarah Johnson">
    </div>
    <div class="form-group">
      <label class="form-label">Email Address <span class="req">*</span></label>
      <input type="email" id="pEmail" class="form-input" placeholder="sarah@company.com">
      <div class="form-hint">Used as login username</div>
    </div>
    <div class="form-group">
      <label class="form-label">Position / Title <span class="req">*</span></label>
      <input type="text" id="pPos" class="form-input" placeholder="Senior Engineer">
    </div>
    <div class="form-group">
      <label class="form-label">Password <span class="req">*</span></label>
      <input type="password" id="pPass" class="form-input" placeholder="Min 6 characters">
      <div class="form-hint">Panelist will use this to log in</div>
    </div>
    <div class="info-box" style="margin-bottom:1rem">
      <strong>‚ÑπÔ∏è</strong> A login account is created automatically. The panelist can sign in immediately.
    </div>
    <div class="btn-row">
      <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="submitAddPanelist()">‚úÖ Add Panelist</button>
    </div>
    <script>setTimeout(()=>document.getElementById('pName').focus(), 80)<\/script>`);
}

function submitAddPanelist() {
  const name = document.getElementById('pName').value.trim();
  const email = document.getElementById('pEmail').value.trim().toLowerCase();
  const pos   = document.getElementById('pPos').value.trim();
  const pass  = document.getElementById('pPass').value;

  if (name.length < 2) { alert('‚ùå Please enter a valid full name.'); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert('‚ùå Please enter a valid email address.'); return; }
  if (!pos) { alert('‚ùå Please enter the position/title.'); return; }
  if (pass.length < 6) { alert('‚ùå Password must be at least 6 characters.'); return; }

  const d = db();
  if (d.users[email]) { alert('‚ùå An account with that email already exists.'); return; }

  d.panelists.push({ id: d.nPanel++, name, email, position: pos });
  d.users[email] = { email, password: pass, name, role: 'panelist' };
  save(d);
  closeModal();
  pgPanelists(document.getElementById('pageContent'));
  alert('‚úÖ Panelist added!\n\nName: ' + name + '\nEmail: ' + email + '\nThey can now log in and evaluate candidates.');
}

function deletePanelist(id) {
  if (!confirm('Remove this panelist? Their submitted evaluations will remain.')) return;
  const d = db();
  const p = d.panelists.find(p=>p.id===id);
  if (p && d.users[p.email]) delete d.users[p.email];
  d.panelists = d.panelists.filter(p=>p.id!==id);
  save(d);
  pgPanelists(document.getElementById('pageContent'));
}

function modalUploadPanelists() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">üì§ Upload Panelists</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="info-box">
      <strong>üìã Template Format:</strong>
      <div class="form-hint" style="margin-top:.5rem">Columns: <code>name, email, position, password</code></div>
    </div>
    <div class="template-row">
      <button class="tmpl-btn" onclick="dlPanelTmpl('csv')">üìÑ CSV Template</button>
      <button class="tmpl-btn" onclick="dlPanelTmpl('xlsx')">üìä Excel Template</button>
    </div>
    <div class="upload-zone" id="pzUpload" onclick="document.getElementById('pzFile').click()">
      <div class="icon">üìÅ</div>
      <div style="font-weight:600;margin-bottom:.35rem">Click to browse or drag & drop</div>
      <div class="form-hint">Supports .csv, .xlsx, .xls files</div>
    </div>
    <input type="file" id="pzFile" style="display:none" accept=".csv,.xlsx,.xls" onchange="parsePanelistFile(event)">
    <div id="pzPreview"></div>
    <script>
      const pz = document.getElementById('pzUpload');
      pz.addEventListener('dragover', e=>{e.preventDefault();pz.classList.add('over')});
      pz.addEventListener('dragleave', ()=>pz.classList.remove('over'));
      pz.addEventListener('drop', e=>{e.preventDefault();pz.classList.remove('over'); const f=e.dataTransfer.files[0]; if(f) parsePanelistFile({target:{files:[f]}})});
    <\/script>`);
}

function dlPanelTmpl(fmt) {
  const rows = [['name','email','position','password'],['Sarah Johnson','sarah@company.com','Senior Engineer','pass123'],['Mark Davis','mark@company.com','Tech Lead','pass456']];
  if (fmt==='csv') {
    const blob = new Blob([rows.map(r=>r.join(',')).join('\n')], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='panelists_template.csv'; a.click();
  } else {
    const ws = XLSX.utils.aoa_to_sheet(rows); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Panelists'); XLSX.writeFile(wb,'panelists_template.xlsx');
  }
}

function parsePanelistFile(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  if (file.name.endsWith('.csv')) {
    Papa.parse(file, { header:true, complete: r => previewPanelists(r.data) });
  } else {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      previewPanelists(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
    };
    reader.readAsArrayBuffer(file);
  }
}

function previewPanelists(rows) {
  const valid = rows.filter(r => r.name && r.email && r.position && r.password);
  const invalid = rows.length - valid.length;
  document.getElementById('pzPreview').innerHTML = `
    <div class="preview-stats">
      <div class="prev-stat"><div class="prev-stat-val">${rows.length}</div><div class="prev-stat-lbl">Total Rows</div></div>
      <div class="prev-stat"><div class="prev-stat-val" style="color:var(--success)">${valid.length}</div><div class="prev-stat-lbl">Valid</div></div>
      <div class="prev-stat"><div class="prev-stat-val" style="color:var(--danger)">${invalid}</div><div class="prev-stat-lbl">Invalid</div></div>
    </div>
    ${valid.length ? `<button class="btn btn-success" style="margin-top:1rem" onclick='importPanelists(${JSON.stringify(valid)})'>‚úÖ Import ${valid.length} Panelist(s)</button>` : '<p class="form-hint" style="text-align:center;margin-top:.75rem">No valid rows found.</p>'}`;
}

function importPanelists(rows) {
  const d = db();
  let added=0, skipped=0;
  rows.forEach(r => {
    const email = r.email.toLowerCase().trim();
    if (d.users[email]) { skipped++; return; }
    d.panelists.push({ id:d.nPanel++, name:r.name, email, position:r.position });
    d.users[email] = { email, password:r.password, name:r.name, role:'panelist' };
    added++;
  });
  save(d);
  closeModal();
  pgPanelists(document.getElementById('pageContent'));
  alert('‚úÖ Import Complete!\n\nAdded: ' + added + '\nSkipped (duplicates): ' + skipped);
}

/* ========================================================
   QUESTIONS
======================================================== */
function pgQuestions(el) {
  const d = db();
  const sections = d.sections.map(sec => `
    <div style="background:rgba(30,41,59,.35);border:1px solid var(--border);border-radius:14px;padding:1.5rem;margin-bottom:1.25rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
        <h3 style="font-size:1.1rem;font-weight:700">${sec.name}</h3>
        <div>
          <button class="act-btn green" onclick="modalAddQuestion(${sec.id})">‚ûï Add Question</button>
          <button class="act-btn red" onclick="deleteSection(${sec.id})">üóëÔ∏è Delete Section</button>
        </div>
      </div>
      ${sec.questions.length ? sec.questions.map((q,i)=>`
        <div class="q-item">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:.75rem">
            <span><strong style="color:var(--muted)">Q${i+1}:</strong> <span style="color:#e2e8f0">${q.text}</span></span>
            <button class="act-btn red" style="flex-shrink:0" onclick="deleteQuestion(${sec.id},${q.id})">üóëÔ∏è</button>
          </div>
        </div>`).join('') : '<p style="text-align:center;color:var(--muted);padding:.75rem">No questions yet ‚Äî click ‚ûï Add Question</p>'}
    </div>`).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìù Question Bank <span class="badge-ai">ü§ñ AI</span></h2>
        <div class="btn-group">
          <button class="btn btn-ai btn-sm" onclick="modalAIGenerate()">‚ú® AI Generate</button>
          <button class="btn btn-primary btn-sm" onclick="modalUploadQuestions()">üì§ Upload</button>
          <button class="btn btn-success btn-sm" onclick="modalAddSection()">‚ûï Add Section</button>
        </div>
      </div>
      ${d.sections.length ? sections : '<div class="empty">üì≠ No sections yet.<br>Use ‚ú® AI Generate to create questions automatically, or ‚ûï Add Section to start manually.</div>'}
    </div>`;
}

function modalAddSection() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">‚ûï Add Section</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Section Name <span class="req">*</span></label>
      <input type="text" id="secName" class="form-input" placeholder="e.g. Leadership Skills">
    </div>
    <div class="btn-row">
      <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="submitAddSection()">üíæ Save Section</button>
    </div>
    <script>setTimeout(()=>document.getElementById('secName').focus(),80)<\/script>`);
}

function submitAddSection() {
  const name = document.getElementById('secName').value.trim();
  if (!name) { alert('‚ùå Please enter a section name.'); return; }
  const d = db();
  d.sections.push({ id: d.nSec++, name, questions:[] });
  save(d);
  closeModal();
  pgQuestions(document.getElementById('pageContent'));
  alert('‚úÖ Section "' + name + '" added!');
}

function deleteSection(id) {
  if (!confirm('Delete this section and all its questions?')) return;
  const d = db();
  d.sections = d.sections.filter(s=>s.id!==id);
  save(d);
  pgQuestions(document.getElementById('pageContent'));
}

function modalAddQuestion(secId) {
  const d = db();
  const sec = d.sections.find(s=>s.id===secId);
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">‚ûï Add Question ‚Äî ${sec.name}</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="form-group">
      <label class="form-label">Question Text <span class="req">*</span></label>
      <textarea id="qText" class="form-textarea" placeholder="Enter your interview question here..."></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="submitAddQuestion(${secId})">üíæ Add Question</button>
    </div>
    <script>setTimeout(()=>document.getElementById('qText').focus(),80)<\/script>`);
}

function submitAddQuestion(secId) {
  const text = document.getElementById('qText').value.trim();
  if (!text) { alert('‚ùå Please enter the question text.'); return; }
  const d = db();
  const sec = d.sections.find(s=>s.id===secId);
  if (sec) { sec.questions.push({ id: d.nQ++, text }); save(d); }
  closeModal();
  pgQuestions(document.getElementById('pageContent'));
}

function deleteQuestion(secId, qId) {
  if (!confirm('Delete this question?')) return;
  const d = db();
  const sec = d.sections.find(s=>s.id===secId);
  if (sec) { sec.questions = sec.questions.filter(q=>q.id!==qId); save(d); }
  pgQuestions(document.getElementById('pageContent'));
}

function modalUploadQuestions() {
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">üì§ Upload Questions</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="info-box">
      <strong>üìã Format:</strong>
      <div class="form-hint" style="margin-top:.5rem">Two columns: <code>section</code> and <code>question</code></div>
    </div>
    <div class="template-row">
      <button class="tmpl-btn" onclick="dlQTmpl('csv')">üìÑ CSV Template</button>
      <button class="tmpl-btn" onclick="dlQTmpl('xlsx')">üìä Excel Template</button>
    </div>
    <div class="upload-zone" id="qzUpload" onclick="document.getElementById('qzFile').click()">
      <div class="icon">üìÅ</div>
      <div style="font-weight:600;margin-bottom:.35rem">Click to browse or drag & drop</div>
      <div class="form-hint">Supports .csv, .xlsx, .xls</div>
    </div>
    <input type="file" id="qzFile" style="display:none" accept=".csv,.xlsx,.xls" onchange="parseQFile(event)">
    <div id="qzPreview"></div>`);
}

function dlQTmpl(fmt) {
  const rows=[['section','question'],['Technical Skills','Describe your experience with relevant technologies'],['Communication','How do you explain complex ideas to non-technical stakeholders?'],['Problem Solving','Walk me through how you approach a difficult challenge']];
  if (fmt==='csv') { const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='questions_template.csv'; a.click(); }
  else { const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Questions'); XLSX.writeFile(wb,'questions_template.xlsx'); }
}

function parseQFile(ev) {
  const file = ev.target.files[0]; if (!file) return;
  if (file.name.endsWith('.csv')) { Papa.parse(file,{header:true,complete:r=>previewQs(r.data)}); }
  else { const reader=new FileReader(); reader.onload=e=>{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); previewQs(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])); }; reader.readAsArrayBuffer(file); }
}

function previewQs(rows) {
  const valid = rows.filter(r=>r.section && r.question);
  const grouped = {};
  valid.forEach(r=>{ if (!grouped[r.section]) grouped[r.section]=[]; grouped[r.section].push(r.question); });
  document.getElementById('qzPreview').innerHTML = `
    <div class="preview-stats">
      <div class="prev-stat"><div class="prev-stat-val">${rows.length}</div><div class="prev-stat-lbl">Total</div></div>
      <div class="prev-stat"><div class="prev-stat-val" style="color:var(--success)">${valid.length}</div><div class="prev-stat-lbl">Valid</div></div>
      <div class="prev-stat"><div class="prev-stat-val">${Object.keys(grouped).length}</div><div class="prev-stat-lbl">Sections</div></div>
    </div>
    ${valid.length ? `<button class="btn btn-success" style="margin-top:1rem" onclick='importQs(${JSON.stringify(valid)})'>‚úÖ Import ${valid.length} Question(s)</button>` : ''}`;
}

function importQs(rows) {
  const d = db();
  rows.forEach(r => {
    let sec = d.sections.find(s=>s.name.toLowerCase()===r.section.toLowerCase());
    if (!sec) { sec={id:d.nSec++,name:r.section,questions:[]}; d.sections.push(sec); }
    sec.questions.push({id:d.nQ++,text:r.question});
  });
  save(d);
  closeModal();
  pgQuestions(document.getElementById('pageContent'));
  alert('‚úÖ Imported ' + rows.length + ' question(s)!');
}

function modalAIGenerate() {
  const roles = {
    'Software Engineer':{'Technical':['Describe your experience with OOP and design patterns','How do you ensure code quality and testability?','Walk through your debugging process for a complex bug'],'Problem Solving':['Describe a time you optimized code for performance','How do you approach unfamiliar codebases?'],'Collaboration':['How do you handle code reviews?','Describe working in an Agile environment']},
    'Product Manager':{'Strategy':['How do you prioritize features on your roadmap?','Describe your market research process'],'Stakeholders':['How do you manage conflicting stakeholder priorities?','How do you communicate product vision to engineers?'],'Analytics':['How do you use data to drive decisions?','Describe an A/B test you ran']},
    'Data Scientist':{'Technical':['Explain your ML model evaluation process','How do you handle imbalanced datasets?','Describe your feature engineering approach'],'Communication':['How do you present findings to business leaders?','How do you explain technical concepts simply?']},
    'UX Designer':{'Design':['Walk through your end-to-end design process','How do you balance aesthetics with usability?'],'Research':['Describe your user research methods','How do you incorporate user feedback?']},
    'HR Manager':{'Recruitment':['How do you source and screen candidates effectively?','Describe your approach to reducing hiring bias'],'Employee Relations':['How do you handle workplace conflicts?','Describe your performance management approach']},
    'Sales':{'Skills':['How do you qualify a lead?','How do you handle common objections?'],'Relationship':['How do you build long-term client relationships?','Describe turning a difficult prospect into a client']}
  };

  const opts = Object.keys(roles).map(r=>`<option value="${r}">${r}</option>`).join('');
  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">‚ú® AI Question Generator</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="ai-box">
      <div class="ai-box-title">ü§ñ Generate Role-Specific Questions</div>
      <p style="color:var(--muted);font-size:.9rem">Select a role and AI will suggest professional interview questions organized by section.</p>
    </div>
    <div class="form-group">
      <label class="form-label">Select Position Type</label>
      <select id="aiRole" class="form-select" onchange="renderAISuggestions(${JSON.stringify(roles).replace(/"/g,'&quot;')})">
        <option value="">-- Choose a role --</option>
        ${opts}
      </select>
    </div>
    <div id="aiSuggestions"></div>`);
}

function renderAISuggestions(roles) {
  const role = document.getElementById('aiRole').value;
  if (!role || !roles[role]) { document.getElementById('aiSuggestions').innerHTML=''; return; }
  const secs = roles[role];
  let html = '<div style="margin-top:1rem">';
  Object.entries(secs).forEach(([sec,qs]) => {
    html += `<div style="background:rgba(30,41,59,.4);border-radius:10px;padding:1rem;margin-bottom:.85rem">
      <strong style="color:#818cf8">${sec}</strong>
      <div style="margin-top:.75rem">`;
    qs.forEach((q,i) => {
      html += `<label style="display:flex;gap:.75rem;align-items:flex-start;margin-bottom:.6rem;cursor:pointer">
        <input type="checkbox" id="aiq_${sec}_${i}" value="${sec}|||${q}" style="margin-top:3px;width:16px;height:16px;flex-shrink:0">
        <span style="color:#e2e8f0;font-size:.9rem">${q}</span>
      </label>`;
    });
    html += '</div></div>';
  });
  html += `<button class="btn btn-ai" onclick="importAIQuestions()">‚úÖ Add Selected Questions</button></div>`;
  document.getElementById('aiSuggestions').innerHTML = html;
}

function importAIQuestions() {
  const checked = document.querySelectorAll('#aiSuggestions input[type=checkbox]:checked');
  if (!checked.length) { alert('‚ö†Ô∏è Please select at least one question.'); return; }
  const d = db(); let added=0;
  checked.forEach(cb => {
    const [secName, qText] = cb.value.split('|||');
    let sec = d.sections.find(s=>s.name===secName);
    if (!sec) { sec={id:d.nSec++,name:secName,questions:[]}; d.sections.push(sec); }
    sec.questions.push({id:d.nQ++,text:qText}); added++;
  });
  save(d);
  closeModal();
  pgQuestions(document.getElementById('pageContent'));
  alert('‚úÖ Added ' + added + ' AI-generated question(s)!');
}

/* ========================================================
   EVALUATIONS (Admin view)
======================================================== */
function pgEvaluations(el) {
  const d = db();
  const rows = d.evaluations.map(e=>`
    <tr>
      <td><strong style="color:#fff">${e.candidateName}</strong></td>
      <td style="color:var(--muted)">${e.panelistName}</td>
      <td><strong style="color:#fff">${e.avgScore.toFixed(1)}/5.0</strong></td>
      <td><span class="badge badge-success">Completed</span></td>
      <td style="color:var(--muted)">${e.date}</td>
      <td style="color:var(--muted);font-size:.85rem;max-width:200px;overflow:hidden;text-overflow:ellipsis">${e.comment || '‚Äî'}</td>
    </tr>`).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">‚≠ê All Evaluations</h2>
        <span style="color:var(--muted);font-size:.9rem">${d.evaluations.length} total</span>
      </div>
      ${d.evaluations.length ? `
        <div class="table-wrap">
          <table>
            <thead><tr><th>Candidate</th><th>Panelist</th><th>Score</th><th>Status</th><th>Date</th><th>Comment</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>` : '<div class="empty">üì≠ No evaluations submitted yet.</div>'}
    </div>`;
}

/* ========================================================
   PANELIST - MY EVALUATIONS
======================================================== */
let myEvalFilter = 'all';

function pgMyEvals(el) {
  const d = db();

  let cands = d.candidates;
  if (myEvalFilter==='done')    cands = d.candidates.filter(c=>d.evaluations.some(e=>e.candidateId===c.id&&e.panelistEmail===CU.email));
  if (myEvalFilter==='pending') cands = d.candidates.filter(c=>!d.evaluations.some(e=>e.candidateId===c.id&&e.panelistEmail===CU.email));

  const doneCount    = d.candidates.filter(c=>d.evaluations.some(e=>e.candidateId===c.id&&e.panelistEmail===CU.email)).length;
  const pendingCount = d.candidates.length - doneCount;

  const chips = [
    {k:'all',     l:'All ('+d.candidates.length+')'},
    {k:'done',    l:'‚úÖ Evaluated ('+doneCount+')'},
    {k:'pending', l:'‚è≥ Pending ('+pendingCount+')'},
  ].map(c=>`<button onclick="myEvalFilter='${c.k}';pgMyEvals(document.getElementById('pageContent'))"
    style="padding:.45rem .95rem;border-radius:20px;border:2px solid ${myEvalFilter===c.k?'var(--primary)':'var(--border)'};
    background:${myEvalFilter===c.k?'rgba(99,102,241,.25)':'rgba(30,41,59,.5)'};
    color:${myEvalFilter===c.k?'#fff':'var(--muted)'};font-weight:600;cursor:pointer;font-size:.8rem;font-family:inherit">
    ${c.l}</button>`).join('');

  const cards = cands.map(c => {
    const evals  = d.evaluations.filter(e=>e.candidateId===c.id && e.status==='completed');
    const myEval = evals.find(e=>e.panelistEmail===CU.email);
    const avg    = evals.length ? (evals.reduce((s,e)=>s+e.avgScore,0)/evals.length).toFixed(1) : 'N/A';
    return `
      <div class="cand-card" onclick="startEval(${c.id})">
        <div style="flex:1;min-width:0">
          <div style="font-size:1.05rem;font-weight:700;margin-bottom:.2rem;color:#fff">${c.name}</div>
          <div style="color:var(--muted);font-size:.88rem">${c.position}</div>
          ${myEval ? '<div style="color:var(--muted);font-size:.78rem;margin-top:.2rem">Your score: <strong style="color:var(--success)">'+myEval.avgScore.toFixed(1)+'/5.0</strong> &bull; '+myEval.date+'</div>' : ''}
        </div>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;flex-shrink:0">
          <div style="text-align:center">
            <div style="font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.15rem">Avg Score</div>
            <div style="font-weight:700;font-size:1.05rem;color:#fff">${avg}${avg!=='N/A'?'/5.0':''}</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.15rem">Evaluations</div>
            <div style="font-weight:700;font-size:1.05rem;color:#fff">${evals.length}</div>
          </div>
          <span class="badge ${myEval?'badge-success':'badge-warning'}">${myEval?'‚úÖ Done':'‚è≥ Pending'}</span>
        </div>
      </div>`;
  }).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìù My Evaluations</h2>
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
          <span style="color:var(--muted);font-size:.85rem">Logged in as <strong style="color:#fff">${CU.name}</strong></span>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.25rem">${chips}</div>
      ${cands.length ? cards : '<div class="empty">üì≠ No candidates match this filter.</div>'}
      <div class="info-box" style="margin-top:1.25rem">
        <strong>‚ÑπÔ∏è How it works</strong>
        <div class="form-hint" style="margin-top:.5rem">
          ‚Ä¢ Click any candidate card to start or view an evaluation<br>
          ‚Ä¢ Each panelist evaluates each candidate once<br>
          ‚Ä¢ Final score = average of all panelist scores<br>
          ‚Ä¢ Rankings update automatically after each submission
        </div>
      </div>
    </div>`;
}

/* ========================================================
   EVALUATION FORM
======================================================== */
let evalScores = {};

function startEval(candId) {
  const d = db();
  const cand = d.candidates.find(c=>c.id===candId);
  if (!cand) return;
  let totalQ = 0;
  d.sections.forEach(s=>totalQ+=s.questions.length);
  if (totalQ===0) { alert('‚ùå No questions set up yet. Ask admin to add evaluation questions.'); return; }

  evalScores = {};
  const el = document.getElementById('pageContent');

  const sectionsHTML = d.sections.map(sec => `
    <div style="background:rgba(30,41,59,.35);border:1px solid var(--border);border-radius:14px;padding:1.5rem;margin-bottom:1.25rem">
      <h3 style="font-size:1.05rem;font-weight:700;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border)">${sec.name}</h3>
      ${sec.questions.map(q => `
        <div class="q-item">
          <p style="font-weight:600;color:#e2e8f0;margin-bottom:.75rem">${q.text}</p>
          <div class="score-row">
            ${[0,1,2,3,4,5].map(n=>`<button type="button" class="score-btn" id="sb_${q.id}_${n}" onclick="pickScore(${q.id},${n},${totalQ})">${n}</button>`).join('')}
          </div>
          <textarea class="form-textarea" placeholder="Notes (optional)..." style="margin-top:.75rem;min-height:60px"></textarea>
        </div>`).join('')}
    </div>`).join('');

  el.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìù Evaluating: ${cand.name}</h2>
        <button class="btn btn-danger btn-sm" onclick="nav('myevals')">‚Üê Back</button>
      </div>

      <div style="background:rgba(99,102,241,.08);border:1px solid var(--border);border-radius:14px;padding:1.25rem;margin-bottom:1.5rem">
        <div style="font-size:1.15rem;font-weight:700;margin-bottom:.25rem">${cand.name}</div>
        <div style="color:var(--muted)">${cand.position} ‚Ä¢ ${cand.phone}</div>
      </div>

      <div class="form-group">
        <label class="form-label">Select Your Name <span class="req">*</span></label>
        <select id="panelistPick" class="form-select" onchange="checkDupEval(${candId})">
          <option value="">-- Select Panelist --</option>
          ${d.panelists.map(p=>`<option value="${p.email}" ${CU.role==='panelist' && p.email===CU.email ? 'selected':''}>${p.name} (${p.position})</option>`).join('')}
        </select>
      </div>

      <div style="background:rgba(30,41,59,.4);border-radius:12px;padding:1.1rem 1.25rem;margin-bottom:1.5rem">
        <div style="display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:.9rem">
          <span style="color:var(--muted)">Progress</span>
          <span id="progTxt" style="color:var(--muted)">0/${totalQ} answered</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progBar" style="width:0%"></div></div>
      </div>

      ${sectionsHTML}

      <div class="form-group" style="margin-top:1.5rem">
        <label class="form-label">Overall Comment</label>
        <textarea id="evalComment" class="form-textarea" placeholder="Your overall assessment of this candidate..."></textarea>
      </div>

      <button class="btn btn-success" style="margin-top:1rem" onclick="submitEval(${candId}, '${cand.name}', ${totalQ})">‚úÖ Submit Evaluation</button>
    </div>`;
}

function pickScore(qId, score, total) {
  evalScores[qId] = score;
  for (let i=0; i<=5; i++) {
    const b = document.getElementById('sb_'+qId+'_'+i);
    if (b) b.className = 'score-btn' + (i===score ? ' sel' : '');
  }
  const done = Object.keys(evalScores).length;
  const pb = document.getElementById('progBar');
  const pt = document.getElementById('progTxt');
  if (pb) pb.style.width = (done/total*100)+'%';
  if (pt) pt.textContent = done+'/'+total+' answered';
}

function checkDupEval(candId) {
  const email = document.getElementById('panelistPick').value;
  if (!email) return;
  const d = db();
  const ex = d.evaluations.find(e=>e.candidateId===candId && e.panelistEmail===email && e.status==='completed');
  if (ex) {
    alert('‚ö†Ô∏è This panelist already evaluated this candidate!\n\nScore: '+ex.avgScore.toFixed(1)+'/5.0\nDate: '+ex.date);
    document.getElementById('panelistPick').value = '';
  }
}

function submitEval(candId, candName, total) {
  const email = document.getElementById('panelistPick').value;
  if (!email) { alert('‚ö†Ô∏è Please select a panelist from the dropdown.'); return; }

  const answered = Object.keys(evalScores).length;
  if (answered < total) { alert('‚ö†Ô∏è Please answer all questions. '+( total-answered)+' remaining.'); return; }

  const d = db();
  const panelist = d.panelists.find(p=>p.email===email);

  const ex = d.evaluations.find(e=>e.candidateId===candId && e.panelistEmail===email && e.status==='completed');
  if (ex) { alert('‚ùå This panelist has already evaluated this candidate!'); return; }

  const avgScore = Object.values(evalScores).reduce((a,b)=>a+b,0) / total;
  d.evaluations.push({
    id: d.nEval++, candidateId: candId, candidateName: candName,
    panelistEmail: email, panelistName: panelist.name,
    scores: {...evalScores}, avgScore,
    comment: document.getElementById('evalComment').value || '',
    status: 'completed', date: new Date().toLocaleDateString()
  });
  save(d);

  const allEvals = d.evaluations.filter(e=>e.candidateId===candId && e.status==='completed');
  const finalAvg = allEvals.reduce((s,e)=>s+e.avgScore,0)/allEvals.length;

  alert('üéâ Evaluation submitted!\n\nPanelist: '+panelist.name+'\nYour Score: '+avgScore.toFixed(1)+'/5.0\n\nüìä Candidate Final Score:\n'+finalAvg.toFixed(1)+'/5.0 based on '+allEvals.length+' evaluation(s)');
  nav('myevals');
}

/* ========================================================
   AI ANALYSIS MODAL
======================================================== */
function showAIAnalysis(candId) {
  const d = db();
  const cand = d.candidates.find(c=>c.id===candId);
  if (!cand) return;
  const evals = d.evaluations.filter(e=>e.candidateId===candId && e.status==='completed');
  const an = aiAnalysis(cand, evals);

  const recColor = an.rec==='Highly Recommended' ? 'var(--success)' : an.rec==='Recommended' ? 'var(--primary)' : an.rec.includes('Reservations') ? 'var(--warning)' : 'var(--danger)';
  const skillBars = Object.entries(an.skills).map(([sk,sc]) => `
    <div class="skill-bar">
      <div class="skill-hdr"><span style="color:#e2e8f0;font-weight:600">${sk}</span><span style="color:var(--muted)">${sc.toFixed(1)}/5.0</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${(sc/5)*100}%"></div></div>
    </div>`).join('');

  const strengths = an.strengths.map(s=>`<div style="background:rgba(16,185,129,.08);border-left:4px solid var(--success);padding:.85rem;border-radius:6px;margin-bottom:.5rem"><strong style="color:#fff">${s.area}</strong><div style="color:var(--muted);font-size:.88rem;margin-top:.2rem">${s.desc}</div></div>`).join('');
  const improvs  = an.improvs.map(i=>`<div style="background:rgba(245,158,11,.08);border-left:4px solid var(--warning);padding:.85rem;border-radius:6px;margin-bottom:.5rem"><strong style="color:#fff">${i.area}</strong><div style="color:var(--muted);font-size:.88rem;margin-top:.2rem">${i.desc}</div></div>`).join('');

  openModal(`
    <div class="modal-hdr">
      <span class="modal-title">ü§ñ AI Analysis ‚Äî ${cand.name}</span>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem">
      <div style="text-align:center;background:rgba(30,41,59,.5);border-radius:12px;padding:1rem">
        <div style="font-size:2.2rem;font-weight:800;color:var(--primary)">${an.avg.toFixed(1)}<span style="font-size:1rem;color:var(--muted)">/5</span></div>
        <div style="color:var(--muted);font-size:.8rem;margin-top:.25rem">Overall Score</div>
        <div class="progress-bar" style="margin-top:.5rem"><div class="progress-fill" style="width:${an.pct}%"></div></div>
      </div>
      <div style="text-align:center;background:rgba(30,41,59,.5);border-radius:12px;padding:1rem">
        <div style="font-size:2.2rem;font-weight:800;color:var(--ai)">${an.conf}%</div>
        <div style="color:var(--muted);font-size:.8rem;margin-top:.25rem">AI Confidence</div>
        <div class="progress-bar" style="margin-top:.5rem"><div class="progress-fill" style="width:${an.conf}%"></div></div>
      </div>
      <div style="text-align:center;background:rgba(30,41,59,.5);border-radius:12px;padding:1rem">
        <div style="font-size:2.2rem;font-weight:800;color:var(--success)">${an.cons.toFixed(0)}%</div>
        <div style="color:var(--muted);font-size:.8rem;margin-top:.25rem">Consistency</div>
        <div class="progress-bar" style="margin-top:.5rem"><div class="progress-fill" style="width:${an.cons}%"></div></div>
      </div>
    </div>
    <div class="ai-box">
      <div class="ai-box-title">üéØ Recommendation</div>
      <div style="font-size:1.3rem;font-weight:800;color:${recColor};margin-bottom:.75rem">${an.rec}</div>
      <p style="color:#e2e8f0;line-height:1.7;font-size:.95rem">${an.summary}</p>
    </div>
    <div style="margin:1.25rem 0">
      <div style="font-weight:700;margin-bottom:.85rem">üìà Competency Breakdown</div>
      ${skillBars}
    </div>
    ${strengths ? '<div style="margin-bottom:1rem"><div style="font-weight:700;color:var(--success);margin-bottom:.75rem">‚úÖ Key Strengths</div>'+strengths+'</div>' : ''}
    ${improvs  ? '<div style="margin-bottom:1rem"><div style="font-weight:700;color:var(--warning);margin-bottom:.75rem">‚ö†Ô∏è Development Areas</div>'+improvs+'</div>' : ''}
    <div style="text-align:center;color:var(--muted);font-size:.8rem;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">ü§ñ Based on ${an.count} independent evaluation(s)</div>`);
}

/* ========================================================
   REPORTS
======================================================== */
function buildReportHTML(rankings, d, title) {
  let body = '';
  rankings.forEach((r, idx) => {
    const cand = d.candidates.find(c=>c.id===r.candId);
    if (!cand) return;
    const evals = d.evaluations.filter(e=>e.candidateId===r.candId && e.status==='completed');
    const an = aiAnalysis(cand, evals);
    const recColor = r.rec==='Highly Recommended'?'#065f46,#d1fae5':r.rec==='Recommended'?'#1e40af,#dbeafe':r.rec==='Consider'?'#92400e,#fef3c7':'#991b1b,#fee2e2';
    const [rc,rb] = recColor.split(',');
    body += '<div style="page-break-inside:avoid;margin-bottom:32px;border:2px solid #e5e7eb;border-radius:12px;padding:24px">';
    body += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;border-bottom:2px solid #e5e7eb;padding-bottom:16px;flex-wrap:wrap;gap:8px">';
    body += '<div><div style="font-size:1.5rem;font-weight:800">'+'<span style="background:#6366f1;color:#fff;padding:4px 14px;border-radius:20px;font-size:1rem;margin-right:10px">#'+(idx+1)+'</span>'+r.name+'</div><div style="color:#64748b;margin-top:4px">'+cand.position+' | '+cand.email+' | '+cand.phone+'</div></div>';
    body += '<div style="text-align:right"><div style="font-size:2rem;font-weight:800;color:#6366f1">'+r.avg.toFixed(1)+'/5.0</div><span style="background:'+rb+';color:'+rc+';padding:6px 16px;border-radius:20px;font-weight:700;font-size:.9rem;border:2px solid '+rc+'">'+r.rec+'</span></div></div>';
    body += '<div style="background:#fce7f3;border:2px solid #ec4899;border-radius:10px;padding:16px;margin-bottom:16px"><strong style="color:#be185d">ü§ñ AI Analysis</strong><p style="margin-top:8px;line-height:1.7">'+an.summary+'</p></div>';
    body += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;text-align:center">';
    body += '<div style="background:#f8fafc;border-radius:8px;padding:12px"><div style="font-size:1.6rem;font-weight:700;color:#6366f1">'+an.conf+'%</div><div style="color:#64748b;font-size:.85rem">AI Confidence</div></div>';
    body += '<div style="background:#f8fafc;border-radius:8px;padding:12px"><div style="font-size:1.6rem;font-weight:700;color:#8b5cf6">'+an.cons.toFixed(0)+'%</div><div style="color:#64748b;font-size:.85rem">Consistency</div></div>';
    body += '<div style="background:#f8fafc;border-radius:8px;padding:12px"><div style="font-size:1.6rem;font-weight:700;color:#10b981">'+evals.length+'</div><div style="color:#64748b;font-size:.85rem">Evaluations</div></div></div>';
    if (an.strengths.length) { body += '<div style="margin-bottom:12px"><strong style="color:#10b981">‚úÖ Key Strengths</strong><ul style="margin:8px 0 0 20px;line-height:1.8">'+an.strengths.map(s=>'<li><strong>'+s.area+':</strong> '+s.desc+'</li>').join('')+'</ul></div>'; }
    if (an.improvs.length)  { body += '<div style="margin-bottom:12px"><strong style="color:#f59e0b">‚ö†Ô∏è Development Areas</strong><ul style="margin:8px 0 0 20px;line-height:1.8">'+an.improvs.map(i=>'<li><strong>'+i.area+':</strong> '+i.desc+'</li>').join('')+'</ul></div>'; }
    body += '<strong>üí¨ Panelist Feedback</strong>';
    evals.forEach(ev => { body += '<div style="background:#f9fafb;border-left:4px solid #6366f1;padding:12px;border-radius:6px;margin-top:8px"><div style="display:flex;justify-content:space-between"><strong>'+ev.panelistName+'</strong><span style="color:#6366f1;font-weight:700">'+ev.avgScore.toFixed(1)+'/5.0</span></div><p style="margin-top:4px;color:#475569">'+( ev.comment||'No comment.')+'</p><span style="color:#9ca3af;font-size:.85rem">'+ev.date+'</span></div>'; });
    body += '</div>';
  });

  const avgAll = rankings.length ? (rankings.reduce((s,r)=>s+r.avg,0)/rankings.length).toFixed(1) : 'N/A';
  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Arial,sans-serif;color:#1f2937;padding:40px;max-width:1100px;margin:0 auto}.print-btn{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:12px 28px;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;margin-bottom:24px}@media print{.print-btn{display:none}}</style></head><body>
  <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
  <div style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:36px;border-radius:14px;text-align:center;margin-bottom:32px">
    <h1 style="font-size:2.5rem;font-weight:800;margin-bottom:10px">${title}</h1>
    <p style="opacity:.9;font-size:1.1rem">AI-Powered Comprehensive Analysis</p>
    <p style="opacity:.8;margin-top:8px">Generated: `+new Date().toLocaleString()+`</p>
  </div>
  <div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;padding:24px;margin-bottom:32px">
    <h2 style="font-size:1.6rem;color:#1e293b;margin-bottom:16px;border-bottom:3px solid #6366f1;padding-bottom:8px">üìã Executive Summary</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:16px">
      <div style="background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:16px;text-align:center"><div style="font-size:2.5rem;font-weight:800;color:#6366f1">`+rankings.length+`</div><div style="color:#64748b;font-weight:600">Candidates</div></div>
      <div style="background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:16px;text-align:center"><div style="font-size:2.5rem;font-weight:800;color:#10b981">`+d.evaluations.length+`</div><div style="color:#64748b;font-weight:600">Evaluations</div></div>
      <div style="background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:16px;text-align:center"><div style="font-size:2.5rem;font-weight:800;color:#8b5cf6">`+d.panelists.length+`</div><div style="color:#64748b;font-weight:600">Panelists</div></div>
      <div style="background:#fff;border:2px solid #e2e8f0;border-radius:10px;padding:16px;text-align:center"><div style="font-size:2.5rem;font-weight:800;color:#f59e0b">`+avgAll+`</div><div style="color:#64748b;font-weight:600">Avg Score /5.0</div></div>
    </div>
    ${rankings[0] ? '<p style="margin-top:16px;font-size:1.05rem"><strong>üèÜ Top Candidate:</strong> '+rankings[0].name+' ‚Äî '+rankings[0].avg.toFixed(1)+'/5.0 ('+rankings[0].pct.toFixed(1)+'%) ‚Äî '+rankings[0].rec+'</p>' : ''}
  </div>
  <h2 style="font-size:1.6rem;margin-bottom:20px;border-bottom:3px solid #6366f1;padding-bottom:8px">üèÜ Detailed Candidate Analysis</h2>
  `+body+`
  <div style="text-align:center;margin-top:48px;padding-top:24px;border-top:2px solid #e5e7eb;color:#6b7280">
    <p style="font-weight:700;font-size:1.1rem">AI-Powered Interview Evaluation System</p>
    <p style="margin-top:6px">This report was auto-generated using advanced AI analysis &bull; Confidential</p>
  </div>
  <button class="print-btn" onclick="window.print()" style="display:block;margin:32px auto 0">üñ®Ô∏è Print / Save as PDF</button>
  </body></html>`;
}

function openReportWindow(html) {
  try {
    const w = window.open('', '_blank');
    if (!w || w.closed || typeof w.closed === 'undefined') throw new Error('blocked');
    w.document.open(); w.document.write(html); w.document.close(); w.focus();
    alert('‚úÖ Report opened in new tab!\n\nClick the Print button inside to save as PDF.');
  } catch (err) {
    const blob = new Blob([html], {type:'text/html;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'report_' + new Date().toISOString().split('T')[0] + '.html';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    alert('‚úÖ Report downloaded!\n\nOpen the HTML file in your browser and click Print to save as PDF.\n\n(Tip: Enable popups for instant preview)');
  }
}

function viewReport() {
  const d = db(); const r = calcRankings();
  if (!r.length) { alert('‚ùå No evaluation data yet.'); return; }
  openReportWindow(buildReportHTML(r, d, 'Candidate Evaluation Report'));
}

function genConsolidatedReport() {
  const d = db(); const r = calcRankings();
  if (!r.length) { alert('‚ùå No evaluation data yet.'); return; }
  openReportWindow(buildReportHTML(r, d, 'Consolidated Candidate Evaluation Report'));
}

function exportCSV() {
  const d = db(); const r = calcRankings();
  if (!r.length) { alert('‚ùå No data to export.'); return; }
  let csv = 'Rank,Name,Position,Phone,Email,Avg Score,Percentage,Evaluations,Recommendation\n';
  r.forEach((row,i) => {
    const c = d.candidates.find(c=>c.id===row.candId);
    if (c) csv += [i+1,'"'+row.name+'"','"'+row.position+'"',c.phone,c.email,row.avg.toFixed(2),row.pct.toFixed(1)+'%',row.count,'"'+row.rec+'"'].join(',')+'\n';
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'evaluation_report_'+new Date().toISOString().split('T')[0]+'.csv';
  a.click();
  alert('‚úÖ CSV downloaded!');
}

function exportExcel() {
  const d = db(); const r = calcRankings();
  if (!r.length) { alert('‚ùå No data to export.'); return; }
  const wb = XLSX.utils.book_new();
  const sum = [['Metric','Value'],['Total Candidates',r.length],['Total Evaluations',d.evaluations.length],['Active Panelists',d.panelists.length],['Highly Recommended',r.filter(x=>x.rec==='Highly Recommended').length],['Top Candidate',r[0]?.name||'N/A'],['Top Score',r[0]?.avg.toFixed(1)||'N/A']];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sum), 'Summary');
  const rankData = [['Rank','Name','Position','Avg Score','Percentage','Evaluations','Recommendation']];
  r.forEach((row,i) => { const c=d.candidates.find(c=>c.id===row.candId); if(c) rankData.push([i+1,row.name,row.position,row.avg.toFixed(2),row.pct.toFixed(1)+'%',row.count,row.rec]); });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rankData), 'Rankings');
  const evalData = [['Candidate','Panelist','Score','Date','Comment']];
  d.evaluations.forEach(e => evalData.push([e.candidateName,e.panelistName,e.avgScore.toFixed(2),e.date,e.comment||'']));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(evalData), 'Evaluations');
  XLSX.writeFile(wb, 'evaluation_report_'+new Date().toISOString().split('T')[0]+'.xlsx');
  alert('‚úÖ Excel downloaded! 3 sheets: Summary, Rankings, Evaluations.');
}
</script>
</body>
</html>
